@page "/settings"
@using System.Globalization
@using Wherlog.Helpers
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SettingsPage> Loc
@inject NavigationManager Navigation

<FluentDesignTheme @bind-Mode="@mode" StorageName="theme" />

<PageTitle>@Loc["TitleText"]</PageTitle>
<h1>@Loc["TitleText"]</h1>

<FluentStack Orientation="Orientation.Vertical">
    <div>
        <h4>Theme</h4>
        <FluentSelect
            Width="250px"
            Items="@(Enum.GetValues<DesignThemeModes>())"
            @bind-SelectedOption="@mode" />
    </div>

    <div>
        <h4>Language</h4>
        <FluentSelect
            Width="250px"
            Items="@LanguageHelper.SupportCultures"
            @bind-SelectedOption="SelectedLanguage">
            <OptionTemplate>
                @context.DisplayName
            </OptionTemplate>
        </FluentSelect>
    </div>

    <div>
        <h4>Navigate</h4>
        <FluentStack>
            <FluentTextField @bind-Value="path" />
            <FluentButton OnClick="@(() => Navigation.NavigateTo(path ?? string.Empty))">前往</FluentButton>
        </FluentStack>
    </div>

    <div>
        <h4>Others</h4>
        <FluentButton OnClick="ResetAsync">
            Reset
        </FluentButton>
    </div>
</FluentStack>

@code
{
    private DesignThemeModes mode;
    private string path;

    private CultureInfo culture;
    private CultureInfo SelectedLanguage
    {
        get => culture;
        set
        {
            if (culture != value)
            {
                culture = value;
                _ = SetLanguageAsync(value);
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        string lang = await App.SettingsHelper.GetAsync<string>(SettingsHelper.CurrentLanguage);
        if (lang == LanguageHelper.AutoLanguageCode)
        {
            lang = LanguageHelper.GetCurrentLanguage();
        }
        culture = new CultureInfo(lang);
    }

    private async Task SetLanguageAsync(CultureInfo culture)
    {
        if (culture?.Name.Equals(await LanguageHelper.GetLanguageCodeAsync(JSRuntime), StringComparison.OrdinalIgnoreCase) == false)
        {
            CultureInfo.DefaultThreadCurrentUICulture = CultureInfo.DefaultThreadCurrentCulture = culture;
            await App.SettingsHelper.SetAsync(SettingsHelper.CurrentLanguage, culture.Name);
            await LanguageHelper.SetLanguageCodeAsync(LanguageHelper.GetCurrentLanguage().ToLowerInvariant(), JSRuntime);
        }
    }

    private async Task ResetAsync()
    {
        await App.SettingsHelper.ResetAsync();
        await App.SettingsHelper.SetDefaultSettingsAsync();
    }
}
