@page "/"
@using Wherlog.Helpers
@using Wherlog.Models
@using Wherlog.Models.Post
@inject NavigationManager Navigation

<PageTitle>Home</PageTitle>

<h1>Home</h1>

@if (postList == null)
{
    <FluentProgressRing />
}
else
{
    <FluentStack Orientation="Orientation.Vertical">
        @foreach (PostModel post in postList)
        {
            <FluentCard @onclick="() => OnClick(post.Url)">
                <h3>@post.Title</h3>
                @(new MarkupString(post.Excerpt))
            </FluentCard>
        }
    </FluentStack>
}

@code
{
    private RequestHelper request = RequestHelper.Default;
    private PostsModel postsIndex;
    private List<PostModel> postList = [];

    protected override async Task OnInitializedAsync()
    {
        postsIndex = await request.GetPostsAsync().ContinueWith(x => x.Result?.Data);
        foreach (IndexModel<InfoModel> index in postsIndex?.Pages)
        {
            postList.AddRange(await request.GetAsync(index.Api, SourceGenerationContext.Default.EntryPostsIndexModel).ContinueWith(x => x.Result.Data.Posts));
        }
    }

    private void OnClick(string path)
    {
        Navigation.NavigateTo($"/posts/{path}");
    }
}
