@page "/"
@page "/posts"
@using Wherlog.Helpers
@using Wherlog.Models
@using Wherlog.Models.Post
@inject NavigationManager Navigation

@if (Navigation.Uri.Contains("posts"))
{
    <PageTitle>Posts</PageTitle>
    <h1>Posts</h1>
}
else
{
    <PageTitle>Home</PageTitle>
    <h1>Home</h1>
}

@if (postList == null)
{
    <FluentProgressRing />
}
else
{
    <FluentStack Orientation="Orientation.Vertical">
        @foreach (PostModel post in postList)
        {
            <FluentCard>
                <PostLayout Post="@post" />
            </FluentCard>
        }
    </FluentStack>
}

@code
{
    private RequestHelper request = RequestHelper.Default;
    private static PostsModel postsIndex;
    private static List<PostModel> postList;

    protected override async Task OnInitializedAsync()
    {
        postsIndex ??= await request.GetPostsAsync().GetResults();
        postList ??= [];
        if (postList.Count < postsIndex.Count)
        {
            foreach (IndexModel<InfoModel> index in postsIndex?.Pages)
            {
                PostsIndexModel indexModel = await request.GetAsync(index.Api, SourceGenerationContext.Default.EntryPostsIndexModel).GetResults();
                if (indexModel?.Posts?.Length > 0)
                {
                    postList.AddRange(indexModel.Posts);
                }
            }
        }
    }
}
